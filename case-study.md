# Case-study оптимизации

## Актуальная проблема
В нашем проекте возникла серьёзная проблема.

Необходимо было обработать файл с данными, чуть больше ста мегабайт.

У нас уже была программа на `ruby`, которая умела делать нужную обработку.

Она успешно работала на файлах размером пару мегабайт, но для большого файла она работала слишком долго, и не было понятно, закончит ли она вообще работу за какое-то разумное время.

Я решил исправить эту проблему, оптимизировав эту программу.

## Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я придумал использовать такую метрику: тестовый файл на 5_000 строк, до оптимизации объем выделяемой памяти равен 2759Мб(по данным memory_profiler)

## Гарантия корректности работы оптимизированной программы
Программа поставлялась с тестом. Выполнение этого теста в фидбек-лупе позволяет не допустить изменения логики программы при оптимизации.

## Feedback-Loop
Выполняю профилирование на набольшом объеме данных, оптимизирую код, проверяю на большем кол-ве данных и так по кругу, пока не добьюсь нужного результата

## Вникаем в детали системы, чтобы найти главные точки роста
Для того, чтобы найти "точки роста" для оптимизации я воспользовался memory_profiler, ruby-prof, stackprof

Вот какие проблемы удалось найти и решить

### При парсинге даты выделяется большое кол-во памяти и создается много объектов
- memory profiler и ruby prof
- Сократил парсинг даты до 1 вызова map
- Объем потребляемой памяти сократился до 2074Мб
- Парсинг даты по прежнему потребляет много памяти, но на данном этапе считаю эту точку роста оптимизированной.

### Добавление информации о браузерах пользователя в сессии
- memory profiler
- Отрефакторить строку
- Потребление памяти незначительно сократилось до 2057Мб
- По количеству выделяемой памяти данная строка опустилась на 3 место, на данный момент считаем метод оптимизированным

### Добавление объектов в массив через сложение массивов
- memory profiler
- Изменил добавление элемента в массив через оператор <<
- Объем потребляемой памяти сократился до 1985Мб
- На данном этапе добавление элементов в массив не является точкой роста

### Select из массива сессий через сравнение с id пользователя
- memory profiler
- Сделаю из массива сессий хеш, а так же в блоке изменю добваление в массив через оператор <<
- Объем потребляемой памяти сократился до 1971Мб
- На данном этапе добавление элементов в массив не является точкой роста

### Большое количество памяти выделяется при добавлении информации о браузерах(эксплорер, хром)
- memory profiler
- В целом отрефакторю код
- Скорость программы увеличилась, объем выделяемой памяти уменьшился
- На данном этапе добавление элементов в массив не является точкой роста

## Результаты
В результате рефакторинга уменишьлось кол-во потребляемой памяти, а так же увеличилась скорость выполнения программы
