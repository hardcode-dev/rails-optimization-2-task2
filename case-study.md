# Case-study оптимизации

## Актуальная проблема
В нашем проекте возникла серьёзная проблема.

Необходимо было обработать файл с данными, чуть больше ста мегабайт.

У нас уже была программа на `ruby`, которая умела делать нужную обработку.

Она успешно работала на файлах размером пару мегабайт, но для большого файла она работала слишком долго и потребляла большое кол-во RAM

Я решил исправить эту проблему, оптимизировав эту программу.

## Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я придумал использовать такую метрику: *кол-во в МБ потребляемой RAM*

## Гарантия корректности работы оптимизированной программы
Программа поставлялась с тестом. Выполнение этого теста в фидбек-лупе позволяет не допустить изменения логики программы при оптимизации.

## Feedback-Loop
Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`, который позволил мне получать обратную связь по эффективности сделанных изменений за *11 секунд* и потреблять не более *37 MB* RAM в пиковый момент

Вот как я построил `feedback_loop`: 
1) Использовал профилировщик памяти `Valgrind massif`
2) Переписал программу на *потоковый подход* и запустил на полном объеме данных
3) Сразу получилось уложиться во все метрики

## Результаты
В результате проделанной оптимизации наконец удалось обработать файл с данными.
Удалось улучшить следующие метрики и уложиться в заданный бюджет (в сравнении с предущим дз)
1) Скорость работы программы уменьшилась с 30с до 11с
2) Пиковое потребление памяти уменьшилось c 3068 MB до 37 MB

## Защита от регрессии производительности
Для защиты от потери достигнутого прогресса при дальнейших изменениях программы написал скрипт с использованием `benchmark/ips` для замера производительности. Итоговый результат:
```
ruby 2.6.3p62 (2019-04-16 revision 67580) [x86_64-linux]
Warming up --------------------------------------
   generating reportMEMORY USAGE: 51 MB
     1.000 i/100ms
Calculating -------------------------------------
   generating reportMEMORY USAGE: 51 MB
      0.094 (± 0.0%) i/s -      1.000 in  10.584967s
                   with 95.0% confidence
Run options: --seed 41844

# Running:


Finished in 0.001156s, 0.0000 runs/s, 0.0000 assertions/s.
0 runs, 0 assertions, 0 failures, 0 errors, 0 skips
```
